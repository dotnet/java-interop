<Project>

  <Import Project="..\..\build-tools\scripts\NativeToolchain.targets" />

  <PropertyGroup>
    <_NativeTimingLibName Condition=" '$(OS)' != 'Windows_NT' And Exists ('/Library/Frameworks/') ">libNativeTiming.dylib</_NativeTimingLibName>
    <_NativeTimingLibName Condition=" '$(OS)' != 'Windows_NT' And !Exists ('/Library/Frameworks/') ">libNativeTiming.so</_NativeTimingLibName>
    <_NativeTimingLibName Condition=" '$(OS)' == 'Windows_NT' ">NativeTiming.dll</_NativeTimingLibName>
    <_NativeTimingOutputPath>$(OutputPath)$(_NativeTimingLibName)</_NativeTimingOutputPath>
  </PropertyGroup>

  <ItemGroup>
    <None Include="$(_NativeTimingOutputPath)">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </None>
  </ItemGroup>

  <Target Name="_BuildLibs"
      BeforeTargets="Build"
      DependsOnTargets="_PrepareCmake;_BuildNativeTiming">
  </Target>

  <Target Name="_PrepareCmake"
      DependsOnTargets="GetNativeBuildCommands"
      Inputs="CMakeLists.txt;$(MSBuildThisFileFullPath);NativeTiming.csproj"
      Outputs="$(IntermediateOutputPath)CMakeCache.txt">
    <MakeDir Directories="$(IntermediateOutputPath)" />
    <PropertyGroup>
      <_JdkDirs>"-DJDK_INCLUDE_LIST=@(JdkIncludePath, ';')"</_JdkDirs>
    </PropertyGroup>
    <ItemGroup>
      <_Cmake Include="PrepareNativeToolchain=$(PrepareNativeToolchain)" />
      <_Cmake Include="CmakePath=$(CmakePath)" />
      <_Cmake Include="CmakeGenerator=$(CmakeGenerator)" />
      <_Cmake Include="CmakeSourceDir=$(MSBuildThisFileDirectory)" />
      <_Cmake Include="CmakeBuildDir=$(MSBuildThisFileDirectory)$(IntermediateOutputPath)" />
      <_Cmake Include="CmakeExtraArgs=$(_JdkDirs)" />
    </ItemGroup>
    <MSBuild
        Projects="..\..\build-tools\scripts\RunCmake.proj"
        Properties="@(_Cmake)"
        Targets="Cmake"
    />
    <Touch Files="$(IntermediateOutputPath)CMakeCache.txt" />
  </Target>

  <Target Name="_BuildNativeTiming"
      DependsOnTargets="GetNativeBuildCommands"
      Inputs="timing.c;$(MSBuildThisFileFullPath);NativeTiming.csproj"
      Outputs="$(_NativeTimingOutputPath)">
    <Exec
        Command="$(PrepareNativeToolchain) $(NativeToolchainMake) VERBOSE=1"
        WorkingDirectory="$(IntermediateOutputPath)"
    />
    <ItemGroup>
      <_Libs Include="$(IntermediateOutputPath)$(_NativeTimingLibName)*" />
    </ItemGroup>
    <Copy
        SourceFiles="@(_Libs)"
        DestinationFolder="$(OutputPath)"
    />
    <Touch Files="$(_NativeTimingOutputPath)" />
  </Target>

  <Target Name="_Clean"
      AfterTargets="Clean">
    <Delete Files="$(_NativeTimingOutputPath)" />
  </Target>

</Project>
